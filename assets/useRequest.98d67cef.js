var V=Object.defineProperty,x=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable;var E=(s,t,e)=>t in s?V(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,h=(s,t)=>{for(var e in t||(t={}))$.call(t,e)&&E(s,e,t[e]);if(w)for(var e of w(t))z.call(t,e)&&E(s,e,t[e]);return s},B=(s,t)=>x(s,J(t));var _=(s,t)=>{var e={};for(var u in s)$.call(s,u)&&t.indexOf(u)<0&&(e[u]=s[u]);if(s!=null&&w)for(var u of w(s))t.indexOf(u)<0&&z.call(s,u)&&(e[u]=s[u]);return e};var S=(s,t,e)=>(E(s,typeof t!="symbol"?t+"":t,e),e);import{b as Q,s as T,c as X,u as Y}from"./index.4ad47242.js";import{x as m,z as R,I as q,e as D,M as C,t as Z,r as y,y as F}from"./plugin-vue_export-helper.cdf78444.js";import{d as G}from"./debounce.6853a4a3.js";import{t as O}from"./throttle.e0a0647a.js";const H=new Map,k=(s,t,e)=>{const u=H.get(s);u!=null&&u.timer&&clearTimeout(u.timer);let r;t>-1&&(r=setTimeout(()=>{H.delete(s)},t)),H.set(s,B(h({},e),{timer:r}))},L=s=>H.get(s),p=new Map,b=s=>p.get(s),K=(s,t)=>{p.set(s,t),t.then(e=>(p.delete(s),e)).catch(e=>{throw p.delete(s),e})},g={},W=(s,t)=>{g[s]&&g[s].forEach(e=>e(t))},j=(s,t)=>(g[s]||(g[s]=[]),g[s].push(t),function(){const u=g[s].indexOf(t);g[s].splice(u,1)}),I=(s,{cacheKey:t,cacheTime:e=5*60*1e3,staleTime:u=0,setCache:r,getCache:a})=>{const i=m(),c=m(),f=(o,n)=>{r?r(n):k(o,e,n),W(o,n.data)},l=(o,n=[])=>a?a(n):L(o);return R(()=>{if(!t)return;const o=l(t);o&&Object.hasOwnProperty.call(o,"data")&&(s.state.data=o.data,s.state.params=o.params,console.log("staleTime",u),(u===-1||new Date().getTime()-o.time<=u)&&(s.state.loading=!1)),i.value=j(t,n=>{s.setState({data:n})})}),q(()=>{var o;(o=i.value)==null||o.call(i)}),t?{onBefore:o=>{const n=l(t,o);return!n||!Object.hasOwnProperty.call(n,"data")?{}:u===-1||new Date().getTime()-n.time<=u?(console.log("\u505C\u6B62\u8BF7\u6C42"),{loading:!1,data:n==null?void 0:n.data,returnNow:!0}):{data:n==null?void 0:n.data}},onRequest:(o,n)=>{let v=b(t);return v&&v!==c.value?{servicePromise:v}:(v=o(...n),c.value=v,K(t,v),{servicePromise:v})},onSuccess:(o,n)=>{var v;t&&((v=i.value)==null||v.call(i),f(t,{data:o,params:n,time:new Date().getTime()}),i.value=j(t,d=>{s.setState({data:d})}))},onMutate:o=>{var n;t&&((n=i.value)==null||n.call(i),f(t,{data:o,params:s.state.params,time:new Date().getTime()}),i.value=j(t,v=>{s.setState({data:v})}))}}:{}},tt=(s,{debounceWait:t,debounceLeading:e,debounceTrailing:u,debounceMaxWait:r})=>{const a=m(),i=D(()=>{const c={};return(e==null?void 0:e.value)!==void 0&&(c.leading=e.value),(u==null?void 0:u.value)!==void 0&&(c.trailing=u.value),(r==null?void 0:r.value)!==void 0&&(c.maxWait=r.value),c});return R(c=>{if(t){const f=s.runAsync.bind(s);a.value=G(l=>{l()},t,i.value),s.runAsync=(...l)=>new Promise((o,n)=>{var v;(v=a.value)==null||v.call(a,()=>{f(...l).then(o).catch(n)})}),c(()=>{var l;(l=a.value)==null||l.cancel(),s.runAsync=f})}}),t?{onCancel:()=>{var c;(c=a.value)==null||c.cancel()}}:{}},et=(s,{loadingDelay:t})=>{const e=m();if(C(t)?!t.value:!t)return{};const u=()=>{e.value&&clearTimeout(e.value)};return{onBefore:()=>(u(),e.value=setTimeout(()=>{s.setState({loading:!0})},C(t)?t.value:t),{loading:!1}),onFinally:()=>{u()},onCancel:()=>{u()}}},st=(s,{pollingInterval:t,pollingWhenHidden:e=m(!0)})=>{const u=m(),r=m(),a=()=>{var i;u.value&&clearInterval(u.value),(i=r.value)==null||i.call(r)};return R(()=>{(C(t)?!(t!=null&&t.value):!t)&&a()}),(C(t)?!(t!=null&&t.value):!t)?{}:{onBefore:()=>{a()},onFinally:()=>{if(!e.value&&!Q()){r.value=T(()=>{s.refresh()});return}u.value=setInterval(()=>{s.refresh()},C(t)?t==null?void 0:t.value:t)},onCancel:()=>{a()}}};function ut(s,t){let e=!1;return(...u)=>{e||(e=!0,s(...u),setTimeout(()=>{e=!1},t))}}const nt=(s,{refreshOnWindowFocus:t,focusTimespan:e=5e3})=>{const u=m(),r=()=>{var a;(a=u.value)==null||a.call(u)};return R(a=>{if(C(t==null?void 0:t.value)?t==null?void 0:t.value:t){const i=ut(s.refresh.bind(s),e);u.value=X(()=>{i()})}a(()=>{r()})}),q(()=>{r()}),{}},rt=(s,{retryInterval:t,retryCount:e})=>{const u=m(),r=m(0),a=m(!1);return e?{onBefore:()=>{a.value||(r.value=0),a.value=!1,u.value&&clearTimeout(u.value)},onSuccess:()=>{r.value=0},onError:()=>{if(r.value+=1,e===-1||r.value<=e){const i=t!=null?t:Math.min(1e3*2**r.value,3e4);u.value=setTimeout(()=>{a.value=!0,s.refresh()},i)}else r.value=0},onCancel:()=>{r.value=0,u.value&&clearTimeout(u.value)}}:{}},at=(s,{throttleWait:t,throttleLeading:e,throttleTrailing:u})=>{const r=m(),a={};return(e==null?void 0:e.value)!==void 0&&(a.leading=e.value),(u==null?void 0:u.value)!==void 0&&(a.trailing=u.value),R(i=>{if(t){const c=s.runAsync.bind(s);r.value=O(f=>{f()},t,a),s.runAsync=(...f)=>new Promise((l,o)=>{var n;(n=r.value)==null||n.call(r,()=>{c(...f).then(l).catch(o)})}),i(()=>{var f;s.runAsync=c,(f=r.value)==null||f.cancel()})}}),t?{onCancel:()=>{var i;(i=r.value)==null||i.cancel()}}:{}};class it{constructor(t,e,u,r={}){S(this,"pluginImpls");S(this,"count",0);S(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=t,this.options=e,this.setUpdataData=u,this.initState=r,this.state=h(B(h({},this.state),{loading:!e.manual}),r)}setState(t={}){this.state=h(h({},this.state),t),this.setUpdataData(this.state)}runPluginHandler(t,...e){var r;const u=(r=this.pluginImpls)==null?void 0:r.map(a=>{var i;return(i=a[t])==null?void 0:i.call(a,...e)}).filter(Boolean);return Object.assign({},...u)}async runAsync(...t){var c,f,l,o,n,v,d,N,U,M;this.count+=1;const e=this.count,i=this.runPluginHandler("onBefore",t),{stopNow:u=!1,returnNow:r=!1}=i,a=_(i,["stopNow","returnNow"]);if(u)return new Promise(()=>{});if(this.setState(h({loading:!0,params:t},a)),r)return Promise.resolve(a.data);(f=(c=this.options).onBefore)==null||f.call(c,t);try{let{servicePromise:P}=this.runPluginHandler("onRequest",this.serviceRef.value,t);P||(P=this.serviceRef.value(...t));const A=await P;return e!==this.count?new Promise(()=>{}):(this.setState({data:A,error:void 0,loading:!1}),(o=(l=this.options).onSuccess)==null||o.call(l,A,t),this.runPluginHandler("onSuccess",A,t),(v=(n=this.options).onFinally)==null||v.call(n,t,A,void 0),e===this.count&&this.runPluginHandler("onFinally",t,A,void 0),A)}catch(P){if(e!==this.count)return new Promise(()=>{});throw this.setState({error:P,loading:!1}),(N=(d=this.options).onError)==null||N.call(d,P,t),this.runPluginHandler("onError",P,t),(M=(U=this.options).onFinally)==null||M.call(U,t,void 0,P),e===this.count&&this.runPluginHandler("onFinally",t,void 0,P),P}}run(...t){this.runAsync(...t).catch(e=>{this.options.onError||console.error(e)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(t){let e;typeof t=="function"?e=t==null?void 0:t(this.state.data):e=t,this.runPluginHandler("onMutate",e),this.setState({data:e})}}function ot(s,t={},e=[]){const o=t,{manual:u=!1}=o,r=_(o,["manual"]),a=h({manual:u},r),i=m(s),c=y({data:void 0,loading:!0,params:void 0,error:void 0}),f=n=>{c.data=n.data,c.loading=n.loading,c.error=n.error,c.params=n.params,l.value.state=n},l=D(()=>{const n=e.map(v=>{var d;return(d=v==null?void 0:v.onInit)==null?void 0:d.call(v,a)}).filter(Boolean);return new it(i,a,f,Object.assign({},...n))});return l.value.options=a,l.value.pluginImpls=e.map(n=>n(l.value,a)),F(()=>{if(!u){const n=l.value.state.params||t.defaultParams||[];l.value.run(...n)}}),q(()=>{l.value.cancel()}),B(h({},Z(c)),{cancel:l.value.cancel,refresh:l.value.refresh,refreshAsync:l.value.refreshAsync,run:l.value.run,runAsync:l.value.runAsync,mutate:l.value.mutate})}function Pt(s,t,e){return ot(s,t,[...e||[],tt,et,st,nt,at,Y,I,rt])}export{Pt as u};
