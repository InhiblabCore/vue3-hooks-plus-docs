var V=Object.defineProperty,x=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var E=(s,t,e)=>t in s?V(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,P=(s,t)=>{for(var e in t||(t={}))M.call(t,e)&&E(s,e,t[e]);if(w)for(var e of w(t))$.call(t,e)&&E(s,e,t[e]);return s},B=(s,t)=>x(s,J(t));var _=(s,t)=>{var e={};for(var u in s)M.call(s,u)&&t.indexOf(u)<0&&(e[u]=s[u]);if(s!=null&&w)for(var u of w(s))t.indexOf(u)<0&&$.call(s,u)&&(e[u]=s[u]);return e};var S=(s,t,e)=>(E(s,typeof t!="symbol"?t+"":t,e),e);import{b as Q,s as T,c as X,u as Y}from"./index.c01689e5.js";import{x as m,z as R,I as j,e as z,M as C,t as Z,r as F,y as G}from"./plugin-vue_export-helper.27f58bcd.js";import{d as O}from"./debounce.ade62cbc.js";import{t as y}from"./throttle.0091a310.js";const p=new Map,b=(s,t,e)=>{const u=p.get(s);u!=null&&u.timer&&clearTimeout(u.timer);let r;t>-1&&(r=setTimeout(()=>{p.delete(s)},t)),p.set(s,B(P({},e),{timer:r}))},L=s=>p.get(s),H=new Map,k=s=>H.get(s),K=(s,t)=>{H.set(s,t),t.then(e=>(H.delete(s),e)).catch(e=>{throw H.delete(s),e})},A={},W=(s,t)=>{A[s]&&A[s].forEach(e=>e(t))},U=(s,t)=>(A[s]||(A[s]=[]),A[s].push(t),function(){const u=A[s].indexOf(t);A[s].splice(u,1)}),I=(s,{cacheKey:t,cacheTime:e=5*60*1e3,staleTime:u=0,setCache:r,getCache:a})=>{const i=m(),c=m(),f=(l,n)=>{r?r(n):b(l,e,n),W(l,n.data)},o=(l,n=[])=>a?a(n):L(l);return R(()=>{if(!t)return;const l=o(t);l&&Object.hasOwnProperty.call(l,"data")&&(s.state.data=l.data,s.state.params=l.params,console.log("staleTime",u),(u===-1||new Date().getTime()-l.time<=u)&&(s.state.loading=!1)),i.value=U(t,n=>{s.setState({data:n})})}),j(()=>{var l;(l=i.value)==null||l.call(i)}),t?{onBefore:l=>{const n=o(t,l);return!n||!Object.hasOwnProperty.call(n,"data")?{}:u===-1||new Date().getTime()-n.time<=u?(console.log("\u505C\u6B62\u8BF7\u6C42"),{loading:!1,data:n==null?void 0:n.data,returnNow:!0}):{data:n==null?void 0:n.data}},onRequest:(l,n)=>{let v=k(t);return v&&v!==c.value?{servicePromise:v}:(v=l(...n),c.value=v,K(t,v),{servicePromise:v})},onSuccess:(l,n)=>{var v;t&&((v=i.value)==null||v.call(i),f(t,{data:l,params:n,time:new Date().getTime()}),i.value=U(t,d=>{s.setState({data:d})}))},onMutate:l=>{var n;t&&((n=i.value)==null||n.call(i),f(t,{data:l,params:s.state.params,time:new Date().getTime()}),i.value=U(t,v=>{s.setState({data:v})}))}}:{}},tt=(s,{debounceWait:t,debounceLeading:e,debounceTrailing:u,debounceMaxWait:r})=>{const a=m(),i=z(()=>{const c={};return(e==null?void 0:e.value)!==void 0&&(c.leading=e.value),(u==null?void 0:u.value)!==void 0&&(c.trailing=u.value),(r==null?void 0:r.value)!==void 0&&(c.maxWait=r.value),c});return R(c=>{if(t){const f=s.runAsync.bind(s);a.value=O(o=>{o()},t,i.value),s.runAsync=(...o)=>new Promise((l,n)=>{var v;(v=a.value)==null||v.call(a,()=>{f(...o).then(l).catch(n)})}),c(()=>{var o;(o=a.value)==null||o.cancel(),s.runAsync=f})}}),t?{onCancel:()=>{var c;(c=a.value)==null||c.cancel()}}:{}},et=(s,{loadingDelay:t})=>{const e=m();if(C(t)?!t.value:!t)return{};const u=()=>{e.value&&clearTimeout(e.value)};return{onBefore:()=>(u(),e.value=setTimeout(()=>{s.setState({loading:!0})},C(t)?t.value:t),{loading:!1}),onFinally:()=>{u()},onCancel:()=>{u()}}},st=(s,{pollingInterval:t,pollingWhenHidden:e=!0})=>{const u=m(),r=m(),a=()=>{var i;u.value&&clearInterval(u.value),(i=r.value)==null||i.call(r)};return R(()=>{(C(t)?!(t!=null&&t.value):!t)&&a()}),(C(t)?!(t!=null&&t.value):!t)?{}:{onBefore:()=>{a()},onFinally:()=>{if(!e&&!Q()){r.value=T(()=>{s.refresh()});return}u.value=setInterval(()=>{s.refresh()},C(t)?t==null?void 0:t.value:t)},onCancel:()=>{a()}}};function ut(s,t){let e=!1;return(...u)=>{e||(e=!0,s(...u),setTimeout(()=>{e=!1},t))}}const nt=(s,{refreshOnWindowFocus:t,focusTimespan:e=5e3})=>{const u=m(),r=()=>{var a;(a=u.value)==null||a.call(u)};return R(a=>{if(C(t==null?void 0:t.value)?t==null?void 0:t.value:t){const i=ut(s.refresh.bind(s),e);u.value=X(()=>{i()})}a(()=>{r()})}),j(()=>{r()}),{}},rt=(s,{retryInterval:t,retryCount:e})=>{const u=m(),r=m(0),a=m(!1);return e?{onBefore:()=>{a.value||(r.value=0),a.value=!1,u.value&&clearTimeout(u.value)},onSuccess:()=>{r.value=0},onError:()=>{if(r.value+=1,e===-1||r.value<=e){const i=t!=null?t:Math.min(1e3*2**r.value,3e4);u.value=setTimeout(()=>{a.value=!0,s.refresh()},i)}else r.value=0},onCancel:()=>{r.value=0,u.value&&clearTimeout(u.value)}}:{}},at=(s,{throttleWait:t,throttleLeading:e,throttleTrailing:u})=>{const r=m(),a={};return(e==null?void 0:e.value)!==void 0&&(a.leading=e.value),(u==null?void 0:u.value)!==void 0&&(a.trailing=u.value),R(i=>{if(t){const c=s.runAsync.bind(s);r.value=y(f=>{f()},t,a),s.runAsync=(...f)=>new Promise((o,l)=>{var n;(n=r.value)==null||n.call(r,()=>{c(...f).then(o).catch(l)})}),i(()=>{var f;s.runAsync=c,(f=r.value)==null||f.cancel()})}}),t?{onCancel:()=>{var i;(i=r.value)==null||i.cancel()}}:{}};class it{constructor(t,e,u,r={}){S(this,"pluginImpls");S(this,"count",0);S(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=t,this.options=e,this.setUpdataData=u,this.initState=r,this.state=P(B(P({},this.state),{loading:!e.manual}),r)}setState(t={}){this.state=P(P({},this.state),t),this.setUpdataData(this.state)}setData(t,e){e instanceof Array?e.forEach(u=>{this.state[u]=t,this.setUpdataData(t,u)}):(this.state[e]=t,this.setUpdataData(t,e))}runPluginHandler(t,...e){var r;const u=(r=this.pluginImpls)==null?void 0:r.map(a=>{var i;return(i=a[t])==null?void 0:i.call(a,...e)}).filter(Boolean);return Object.assign({},...u)}async runAsync(...t){var c,f,o,l,n,v,d,q,D,N;this.count+=1;const e=this.count,i=this.runPluginHandler("onBefore",t),{stopNow:u=!1,returnNow:r=!1}=i,a=_(i,["stopNow","returnNow"]);if(u)return new Promise(()=>{});if(this.setState(P({loading:!0,params:t},a)),r)return Promise.resolve(a.data);(f=(c=this.options).onBefore)==null||f.call(c,t);try{let{servicePromise:h}=this.runPluginHandler("onRequest",this.serviceRef.value,t);h||(h=this.serviceRef.value(...t));const g=await h;return e!==this.count?new Promise(()=>{}):(this.setState({data:g,error:void 0,loading:!1}),(l=(o=this.options).onSuccess)==null||l.call(o,g,t),this.runPluginHandler("onSuccess",g,t),(v=(n=this.options).onFinally)==null||v.call(n,t,g,void 0),e===this.count&&this.runPluginHandler("onFinally",t,g,void 0),g)}catch(h){if(e!==this.count)return new Promise(()=>{});throw this.setState({error:h,loading:!1}),(q=(d=this.options).onError)==null||q.call(d,h,t),this.runPluginHandler("onError",h,t),(N=(D=this.options).onFinally)==null||N.call(D,t,void 0,h),e===this.count&&this.runPluginHandler("onFinally",t,void 0,h),h}}run(...t){this.runAsync(...t).catch(e=>{this.options.onError||console.error(e)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(t){let e;typeof t=="function"?e=t==null?void 0:t(this.state.data):e=t,this.runPluginHandler("onMutate",e),this.setState({data:e})}}function ot(s,t={},e=[]){const l=t,{manual:u=!1}=l,r=_(l,["manual"]),a=P({manual:u},r),i=m(s),c=F({data:void 0,loading:!0,params:void 0,error:void 0}),f=(n,v)=>{v?c[v]=n:(c.data=n.data,c.loading=n.loading,c.error=n.error,c.params=n.params)},o=z(()=>{const n=e.map(v=>{var d;return(d=v==null?void 0:v.onInit)==null?void 0:d.call(v,a)}).filter(Boolean);return new it(i,a,f,Object.assign({},...n))});return o.value.options=a,o.value.pluginImpls=e.map(n=>n(o.value,a)),G(()=>{if(!u){const n=o.value.state.params||t.defaultParams||[];o.value.run(...n)}}),j(()=>{o.value.cancel()}),B(P({},Z(c)),{cancel:o.value.cancel.bind(o.value),refresh:o.value.refresh.bind(o.value),refreshAsync:o.value.refreshAsync.bind(o.value),run:o.value.run.bind(o.value),runAsync:o.value.runAsync.bind(o.value),mutate:o.value.mutate.bind(o.value)})}function ht(s,t,e){return ot(s,t,[...e||[],tt,et,st,nt,at,Y,I,rt])}export{ht as u};
